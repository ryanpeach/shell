name: Docker CD

# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

on:
  schedule:
    # Run every week at midnight on the first day of the month.
    - cron: '0 0 * * 1'

# Permissions to commit to the repository
permissions:
  contents: write
  packages: write

jobs:
  sort:
    runs-on: ubuntu-latest
    steps:
        - name: Checkout repository
          uses: actions/checkout@v4
        - name: Sort files
          run: ./sort_dockerfile.sh
        - uses: actions/setup-python@v3
        - uses: leafo/gh-actions-lua@v9
        - uses: leafo/gh-actions-luarocks@v4
        - uses: pre-commit/action@v3.0.1

        # Set up BuildKit Docker container builder to be able to build
        # multi-platform images and export cache
        # https://github.com/docker/setup-buildx-action
        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@f95db51fddba0c2d1ec667646a06c2ce06100226 # v3.0.0

        # Build and push Docker image with Buildx (don't push on PR)
        # https://github.com/docker/build-push-action
        - name: Build and push Docker image
          id: build-and-push
          uses: docker/build-push-action@0565240e2d4ab88bba5387d719585280857ece09 # v5.0.0
          with:
            context: .
            push: false
            tags: latest
            cache-from: type=gha
            cache-to: type=gha,mode=max
            platforms: linux/amd64,linux/arm64

        # Commit
        - name: Commit
          run: |
            git config --global user.email "rgpeach10@gmail.com"
            git config --global user.name "Bot"
            git add Dockerfile
            git commit -m "Sort Dockerfile"
            git push origin main
